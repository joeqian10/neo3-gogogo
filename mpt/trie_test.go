package mpt

import (
	"github.com/stretchr/testify/assert"
	"testing"

	"github.com/joeqian10/neo3-gogogo/helper"
)

func TestVerifyProof(t *testing.T) {
	proofStr := "080c0000000102050008720003a69d0798767e0166c14d03e31fc81e147b91287560e7fa19d1561f29759b957703a9495885fc335dd5daa222e49ce0d542c8d6b1094ca51e30b5b2ea17d9b6facc0404040404040404040404040403251d0de36de3bfd935fee7c7c3bee40f68777b87e08f4b3c9eb6164fac558e3a04fd120100040403de0449d75800e662cc5c07b804e72cb2aa7e6bb3c3c8812fa178587b9586089b040404040403ebd5e01d9738d1158597b04e452deb599305fef2f92c1f8e1a112cfb7f94d8830403a065ed1a35318147644d985278da6c38a6c0cfaac1856b388e4f8cb492afd91103de0449d75800e662cc5c07b804e72cb2aa7e6bb3c3c8812fa178587b9586089b03652b8a83ead517596149de57733acfb988d709f46a78fd2e1d7cdca7798e2d16034ee881ac96d9a53b8fc20f18cf4fe7e2ee998276272d385d2ca3db57776022ce03aa2dc96edb7ef06ecf9674559046b8dbd03e1b3c7a1f3a62eaefd9ea13b64b9603d90b274d165198c2045263551c524a390b70ccc13ca527a076db7b5cf714de7e042a01070000000000000003791d0651089230b366bc3bb286aaf6008e7298803ebdaf6a92e92204879717ed92000403a7de2e8df729aa720e5bda2dd4903a092aeb6eb147300a31f7b54b016544e31d03d340ff18882c9b4f6b5dee49b6be575938019edbad4404633e8f27f65d41c2a803f1f3e3558f3a751b5bb2511493e19f382af6b80d38ae306881e3db4bb1d0e4a604037fdf37ec7a2b533746412242f763d665c20593baaabb2f6a528a51fa4d11172b04040404040404040404042401010003538699ec1fb90dfc037ced3617f4d0c8d941a72c5a24e868a5ad96d8d29eb6b352000403904fb8e816446e1b3d1501783006a2f01fb13166117497ed714cc74a385221ad03a2497231297a2a46abf007954393ae6b3e7d9c1f09c3f869aefcaeb8425eb74504040404040404040404040404042701040005000003497d33633b08061b6cc8882bc5a797cb048d1ff916fd984f4bd09671f64fb88dc902c700201ca7d4dcecd3705602d6e285deafa2c8240f2883045d237822ae33d50451f59f208d735f64159b5f9c7a5670dbab887dbb895c012f39003e5fbc55b6fbff9df44414cc9f88a9e96be8e91131b06ea674fbba51c7c99e0500000000000000144f5f702b3f459f222d371052940bb9ce2d86d2ed06756e6c6f636b4a14e14fdd69cf7bf6afb9265ac806e09fea438df7b81425820465d41a57dca24529e88387ac2d787227780f42400000000000000000000000000000000000000000000000000000000000"
	proofData := helper.HexToBytes(proofStr)

	root, _ := helper.UInt256FromString("0x721697bf93a8f96ed125ba481585b2f7e604e962262062df92ce7c7448101bf1")

	id, key, proofs, err := ResolveProof(proofData)
	assert.Nil(t, err)

	value, err := VerifyProof(root, id, key, proofs)
	assert.Nil(t, err)

	assert.Equal(t, "00201ca7d4dcecd3705602d6e285deafa2c8240f2883045d237822ae33d50451f59f208d735f64159b5f9c7a5670dbab887dbb895c012f39003e5fbc55b6fbff9df44414cc9f88a9e96be8e91131b06ea674fbba51c7c99e0500000000000000144f5f702b3f459f222d371052940bb9ce2d86d2ed06756e6c6f636b4a14e14fdd69cf7bf6afb9265ac806e09fea438df7b81425820465d41a57dca24529e88387ac2d787227780f42400000000000000000000000000000000000000000000000000000000000", helper.BytesToHex(value))
}

func TestVerifyProof2(t *testing.T) {
	//stateRoot := helper.HexToBytes("004cda0000104c7d64f173064503266716e59b08d56f46aa8ae9d2a0aae67aa6955f2d366101c60c40c95690efdf66d3d6d4aa9d968a7af27553b689c72f0ae5a2833fdfcc49ebec685f1f23573c6393612f50fcfbb9a44efd2717975c5597345b35532a099c3c1ac10c40d59c5917df4939743b9db3ed85e3e8f40c17632283da3767b9337f7f4994e9e90f78aa0a8649ff4fc585f7f4fd1b27b76638ee1c00a12b832c426f68dbe3d3c10c40e162d615bbe22d26c8f4a79b4e62f6f7844f3828b42681362f0b15f283a85e383951896f34f383d9713c6be2b5d47ec76008490fbd7ce756e754f3416c1958a193130c21021a9af0f51f5e4d9ae64aed1fd52e5d33c642d62ab96381f88c89885cbd091e9c0c21029409f27e2ffb6fd0b3491dc76ed52a4217f81b15d8de236ff4828bbded2866550c2102a819cf5b48c377394da830252911ebf10e233dd15eba1902083dcb7e506d34530c2103c549f7f82e7ce3dd42ebadbe53bc252ec3d53279fc9992a2db2ab74040636f1314419ed0dc3a")
	proof := helper.HexToBytes("081f000000010202000ab20003faa49e3eb9f5706afcb09eca63e97fb70a7c8fc0fe54582eff57e9a9eda7811c0316ad99d39930e5ed8a9d9102197db08f4a7c5c86ca11e261b6f3a0b9b6550ff0037709d8f7f2d7cd8191d7f1eb01b4a59fcc72319752c8df6df295656030fe68f8034db94ceca7ecf2cda445773f3299ca387d21794f5a10f206309a9858845b09a50404040404040404040404034da9746bf082924d353e235c78bb8eb7cec65263bb36755b4cc7e2532d7de51304fdd20100035b87382f8326fbb948f6dadc72b75d68153ae04fb21b0ab381e048e351f5371603170c6a577b08d8cfb48ef8ccacef8a31f85854db2e7c0cba5eea0129f8c50806030f31825b4a4c2d5883b62f117e9946b98fc83e02c6002008e44783ae20e87510031ed4712740edf5b550b9d033664b771ae6919799c1f49156b10e6235f4adb85b038d0d66af3c496709924139c1eb7959b88c91320a8f12331a189933b26f525ab003cad0febb3c01839e171ff6ff664ad2f62dd5afc050612e0f79d8d2d60f2da17b032b522c797e7d349d43f9e254243d69e4ce59fe895ed5c0bd7306ed3fffe6f1590330de70f98131ea2cdcef3860230740126d2fc0bd5f092db02fc1e027cd35404403defb9abe9a03c9c428272a74e6ab6e397c3ad2e85f5a6bf9d62cf6bb0c9d737f037ac8d026f68d2daa2db64c65e4239fb2eb12ab3a035ddbc7b169813fe855d1d8040403426028540c777db462e6f582b41d5cde09afa1aaf4d701214778dc645bfbbeee0361fee55f5a7eb508ef63b49bbae38dcd845febb676d7c7907ec9ed3e85925325035b2c8482177062b6f1fe9c5aee1e76df8d5470641d04543a9dc9604d457475470349c95180b557f4605e885264a04852cb0687dc1de0433cca1316056248d8a58d042a01070000000000000003b1d7e70568351292c8beaf65faf12872ab3ca393d340509b7054e5fa15fab7199200040365a13c6d713fa39905bfdc8089c0751abead637d12b38721b5f04233f203ebcf03a91fdcc46b688f274c9a40ca0954451a44c4525db9036342ce18f959d759a7b303e9eda894371038774436fdb358e870dbd047161138fca05b783550e1b3fc8dab04037fdf37ec7a2b533746412242f763d665c20593baaabb2f6a528a51fa4d11172b04040404040404040404042401010003e047415c56f144c0d4d1c4515f4bbadee579a270cca5107d9a8618287bbe7ae352000403f55cf6e130de55c6d313926d7f90fb91cb4c425e46c16d046a16ba8720b287720338be68f1a99d2967a086dad7d96700e3e5fc3bc6bd274cf41c7011d86033a14804040404040404040404040404042401010003c66eec6a6b47b9fe65899a841e3a5e6bd5e98947928bb197a3c5751f3070f7be52000404030a244012611f97eb581a086ca300daeb9af36cb03c640cc5a1fd3d6c00368e4f0404033496d8c7133d7e9411d1844528ef33282ae117396f865f0b4a4313ad0d7565dc0404040404040404040404250102000003bcc8bd5123cfdea367b37fa420b3cc2bbdfbc9a5d96cf66cc9092c184b4519d5c802c6207015585f5c47874bfc080e1bb8e1331b35791ab4667133390e74fba3658a621b20c493054fd7ecd17bd346c020bce920f5e720c3fba3810ba3e879b9993c352cff14de3a7dff895992cd5a3e452394e7119c7e8f759702000000000000001499ac1a7a27f9abbca8630b3470e25265e073aed806756e6c6f636b4a14fb524c1033b3e4b74518f34703d66a96ae963fad1401efa51217a3e6eb14a8a5c6d6f79ce82d4d466f0100000000000000000000000000000000000000000000000000000000000000")

	root, _ := helper.UInt256FromString("0x61362d5f95a67ae6aaa0d2e98aaa466fd5089be516672603450673f1647d4c10")
	id, key, proofs, err := ResolveProof(proof)
	value, err := VerifyProof(root, id, key, proofs)
	assert.Nil(t, err)

	assert.Equal(t, "207015585f5c47874bfc080e1bb8e1331b35791ab4667133390e74fba3658a621b20c493054fd7ecd17bd346c020bce920f5e720c3fba3810ba3e879b9993c352cff14de3a7dff895992cd5a3e452394e7119c7e8f759702000000000000001499ac1a7a27f9abbca8630b3470e25265e073aed806756e6c6f636b4a14fb524c1033b3e4b74518f34703d66a96ae963fad1401efa51217a3e6eb14a8a5c6d6f79ce82d4d466f0100000000000000000000000000000000000000000000000000000000000000", helper.BytesToHex(value))
}

func TestVerifyProof3(t *testing.T) {
	proof := helper.HexToBytes("081f000000010202000ab20003faa49e3eb9f5706afcb09eca63e97fb70a7c8fc0fe54582eff57e9a9eda7811c03ccd9df84dbed686ad0b333081444781f2e66985333b439f38b0900976cc7884d039ad2986f5590fde7cfc9546e80fcbbfc8bea81600ef11e0c080bda258b9c6aa4034db94ceca7ecf2cda445773f3299ca387d21794f5a10f206309a9858845b09a50404040404040404040404034d141ef277dbe380b65da9b2c3038d372d07ce82ce3a51a0965c16bad550841c04fdd20100035b87382f8326fbb948f6dadc72b75d68153ae04fb21b0ab381e048e351f5371603170c6a577b08d8cfb48ef8ccacef8a31f85854db2e7c0cba5eea0129f8c50806030f31825b4a4c2d5883b62f117e9946b98fc83e02c6002008e44783ae20e87510031ed4712740edf5b550b9d033664b771ae6919799c1f49156b10e6235f4adb85b038d0d66af3c496709924139c1eb7959b88c91320a8f12331a189933b26f525ab003cad0febb3c01839e171ff6ff664ad2f62dd5afc050612e0f79d8d2d60f2da17b032b522c797e7d349d43f9e254243d69e4ce59fe895ed5c0bd7306ed3fffe6f1590330de70f98131ea2cdcef3860230740126d2fc0bd5f092db02fc1e027cd35404403defb9abe9a03c9c428272a74e6ab6e397c3ad2e85f5a6bf9d62cf6bb0c9d737f037ac8d026f68d2daa2db64c65e4239fb2eb12ab3a035ddbc7b169813fe855d1d8040403426028540c777db462e6f582b41d5cde09afa1aaf4d701214778dc645bfbbeee039c16ce5a75b471061aa773b70ad1522d2e8520504d3f63021c30376ff6749ef4035b2c8482177062b6f1fe9c5aee1e76df8d5470641d04543a9dc9604d45747547033b12d33220b21d9fcfefb6ade85b1d94191c2f5b741ad68ed4648354d8efbcb4042a0107000000000000000334adb9a9dec9ef20e6c59fca8e4ce09e987195cf7f9cf3b4c25369f6fac2015b920004034bda88e5c4a995813aff5bb43a42eb18587537461b7e068b7e1d43b861a2f2a403a91fdcc46b688f274c9a40ca0954451a44c4525db9036342ce18f959d759a7b303e9eda894371038774436fdb358e870dbd047161138fca05b783550e1b3fc8dab04037fdf37ec7a2b533746412242f763d665c20593baaabb2f6a528a51fa4d11172b04040404040404040404042401010003d6c6496b7bc20bcc26082e6bf29165b488b1fadc294e481d535b92eb5cdad3fa52000403f55cf6e130de55c6d313926d7f90fb91cb4c425e46c16d046a16ba8720b287720350e677fe6f4fd21777fdb7718a767ebb8e183ca3e817aba079e5a40cacfde26d040404040404040404040404040424010100037947f695060eb12e9ae82ef3bf0ab471e18cdbebf957a516a8f5cb1d609208d0520004040397a85d7be923e0d6bf5f5f2c499b648b04de0c2bd4909d222e27c1fd8736ed4c0404033496d8c7133d7e9411d1844528ef33282ae117396f865f0b4a4313ad0d7565dc04040404040404040404042501020000034bc83c75e3c5c7869a253b4de108e3cbb9920c8710e14a61c7ce29f41de2a4ebc802c620bbe8f99937889db4c1dd171f0813f438d429eb17507f422a9bbc38d966885a4b2052673e874729182478f83e2142558979f76caa76ec97876c3cb17264bda943f214de3a7dff895992cd5a3e452394e7119c7e8f7597020000000000000014d8ae73e06552e270340b63a8bcabf9277a1aac9906756e6c6f636b4a14ad3f96ae966ad60347f31845b7e4b333104c52fb146f464d2de89cf7d6c6a5a814ebe6a31712a5ef010100000000000000000000000000000000000000000000000000000000000000")

	root, _ := helper.UInt256FromString("0x208f0b34a9bc014a54a2e2fdf5d87283aefd8a9ffc51a345bc35af5ee19f7888")
	id, key, proofs, err := ResolveProof(proof)
	value, err := VerifyProof(root, id, key, proofs)
	assert.Nil(t, err)

	assert.Equal(t, "20bbe8f99937889db4c1dd171f0813f438d429eb17507f422a9bbc38d966885a4b2052673e874729182478f83e2142558979f76caa76ec97876c3cb17264bda943f214de3a7dff895992cd5a3e452394e7119c7e8f7597020000000000000014d8ae73e06552e270340b63a8bcabf9277a1aac9906756e6c6f636b4a14ad3f96ae966ad60347f31845b7e4b333104c52fb146f464d2de89cf7d6c6a5a814ebe6a31712a5ef010100000000000000000000000000000000000000000000000000000000000000", helper.BytesToHex(value))
}
